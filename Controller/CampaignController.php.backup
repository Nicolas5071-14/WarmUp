<?php

namespace MauticPlugin\MauticWarmUpBundle\Controller;

use Doctrine\ORM\EntityManagerInterface;
use Mautic\LeadBundle\Model\ListModel;
use MauticPlugin\MauticWarmUpBundle\Entity\Campaign;
use MauticPlugin\MauticWarmUpBundle\Entity\Domain;
use MauticPlugin\MauticWarmUpBundle\Entity\Template;
use MauticPlugin\MauticWarmUpBundle\Entity\WarmupType;
use MauticPlugin\MauticWarmUpBundle\Entity\WarmupContact;
use MauticPlugin\MauticWarmUpBundle\Entity\WarmupSequence;
use MauticPlugin\MauticWarmUpBundle\Form\Type\SimpleCampaignFormType;
use MauticPlugin\MauticWarmUpBundle\Model\CampaignModel;
use MauticPlugin\MauticWarmUpBundle\Model\WarmupProgressionCalculator;
use MauticPlugin\MauticWarmUpBundle\Service\EmailSenderService;
use Symfony\Component\Form\FormFactoryInterface;
use Symfony\Component\HttpFoundation\JsonResponse;
use Symfony\Component\HttpFoundation\RedirectResponse;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\Session\SessionInterface;
use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
use Symfony\Component\HttpFoundation\RequestStack;
use Twig\Environment;

class CampaignController
{
    private EntityManagerInterface $em;
    private CampaignModel $campaignModel;
    private WarmupProgressionCalculator $warmupCalculator;
    private ListModel $segmentModel;
    private EmailSenderService $emailSender;
    private FormFactoryInterface $formFactory;
    private UrlGeneratorInterface $router;
    private RequestStack $requestStack;
    private Environment $twig;

    public function __construct(
        EntityManagerInterface $em,
        CampaignModel $campaignModel,
        WarmupProgressionCalculator $warmupCalculator,
        ListModel $segmentModel,
        EmailSenderService $emailSender,
        FormFactoryInterface $formFactory,
        UrlGeneratorInterface $router,
        RequestStack $requestStack,
        Environment $twig
    ) {
        $this->em = $em;
        $this->campaignModel = $campaignModel;
        $this->warmupCalculator = $warmupCalculator;
        $this->segmentModel = $segmentModel;
        $this->emailSender = $emailSender;
        $this->formFactory = $formFactory;
        $this->router = $router;
        $this->requestStack = $requestStack;
        $this->twig = $twig;
    }

    private function getSession(): SessionInterface
    {
        return $this->requestStack->getSession();
    }

    /**
     * Page principale des campagnes (avec DataTables)
     */
    public function indexAction(Request $request): Response
    {
        return new Response(
            $this->twig->render('@MauticWarmUp/Campaign/index.html.twig')
        );
    }

    /**
     * AJAX: Liste des campagnes pour DataTables
     */
    public function ajaxListCampaignAction(Request $request): JsonResponse
    {
        try {
            $draw = $request->query->getInt('draw', 1);
            $start = $request->query->getInt('start', 0);
            $length = $request->query->getInt('length', 10);
            $search = $request->query->all('search')['value'] ?? '';

            $query = $this->em->createQueryBuilder()
                ->select('c')
                ->from(Campaign::class, 'c')
                ->orderBy('c.createdAt', 'DESC');

            if ($search) {
                $query->andWhere('c.campaignName LIKE :search')
                    ->setParameter('search', '%' . $search . '%');
            }

            $totalRecords = $this->em->createQueryBuilder()
                ->select('COUNT(c.id)')
                ->from(Campaign::class, 'c')
                ->getQuery()
                ->getSingleScalarResult();

            $query->setFirstResult($start)
                ->setMaxResults($length);

            $campaigns = $query->getQuery()->getResult();

            $data = [];
            foreach ($campaigns as $campaign) {
                $data[] = [
                    'id' => $campaign->getId(),
                    'campaignName' => $campaign->getCampaignName(),
                    'status' => $campaign->getStatus(),
                    'statusLabel' => $this->getStatusLabel($campaign->getStatus()),
                    'statusColor' => $this->getStatusColor($campaign->getStatus()),
                    'totalContacts' => $campaign->getTotalContacts(),
                    'emailsSent' => $campaign->getEmailsSent(),
                    'startDate' => $campaign->getStartDate() ? $campaign->getStartDate()->format('Y-m-d H:i') : '',
                    'progress' => $campaign->getProgress(),
                    'actions' => $this->getActionButtons($campaign),
                ];
            }

            return new JsonResponse([
                'draw' => $draw,
                'recordsTotal' => (int) $totalRecords,
                'recordsFiltered' => (int) $totalRecords,
                'data' => $data,
            ]);

        } catch (\Throwable $e) {
            return new JsonResponse([
                'draw' => 1,
                'recordsTotal' => 0,
                'recordsFiltered' => 0,
                'data' => [],
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Créer une nouvelle campagne
     */
    public function newAction(Request $request): Response
    {
        $campaign = new Campaign();
        return $this->showForm($request, $campaign, false);
    }

    /**
     * Éditer une campagne existante
     */
    public function editAction(Request $request, int $id): Response
    {
        $campaign = $this->campaignModel->getEntity($id);
        if (!$campaign) {
            $this->getSession()->getFlashBag()->add('error', 'Campaign not found');
            return new RedirectResponse($this->router->generate('warmup_campaign_index'));
        }

        return $this->showForm($request, $campaign, true);
    }

    /**
     * Afficher le formulaire de campagne
     */
    private function showForm(Request $request, Campaign $campaign, bool $isEdit): Response
    {
        if (!$isEdit) {
            $campaign->setStartDate(new \DateTime('tomorrow 09:00'));
            $campaign->setSendTime(new \DateTime('09:00'));
            $campaign->setStatus('draft');
            $campaign->setStartVolume(20);
            $campaign->setDurationDays(30);
            $campaign->setSendFrequency('daily');
            $campaign->setContactSource('manual');
        }

        $form = $this->formFactory->create(SimpleCampaignFormType::class, $campaign, [
            'is_edit' => $isEdit,
        ]);

        $domains = $this->em->getRepository(Domain::class)->findBy(['isActive' => true]);
        $warmupTypes = $this->em->getRepository(WarmupType::class)->findAll();
        $templates = $this->em->getRepository(Template::class)->findBy(['isActive' => true]);

        return new Response(
            $this->twig->render('@MauticWarmUp/Campaign/simple_form.html.twig', [
                'form' => $form->createView(),
                'campaign' => $campaign,
                'domains' => $domains,
                'warmupTypes' => $warmupTypes,
                'templates' => $templates,
                'isEdit' => $isEdit,
            ])
        );
    }

    /**
     * Sauvegarder la campagne (AJAX)
     */
    public function saveAction(Request $request): JsonResponse
    {
        try {
            $isEdit = $request->request->has('campaign_id') && $request->request->get('campaign_id');
            $campaignId = $isEdit ? (int) $request->request->get('campaign_id') : 0;

            $campaign = $isEdit
                ? $this->campaignModel->getEntity($campaignId)
                : new Campaign();

            if (!$campaign && $isEdit) {
                throw new \Exception('Campaign not found');
            }

            $form = $this->formFactory->create(SimpleCampaignFormType::class, $campaign, [
                'is_edit' => $isEdit,
            ]);

            $form->handleRequest($request);

            if ($form->isSubmitted() && $form->isValid()) {
                // Gérer les contacts
                $contacts = $this->processContacts($campaign, $request);
                $campaign->setTotalContacts(count($contacts));

                // Calculer le plan de warmup
                $warmupPlan = $this->calculateWarmupPlan($campaign);
                $campaign->setCustomMessage(json_encode($warmupPlan));

                // Sauvegarder la campagne
                $this->campaignModel->saveEntity($campaign);

                // Sauvegarder les contacts
                $this->saveContacts($campaign, $contacts);

                return new JsonResponse([
                    'success' => true,
                    'message' => $isEdit ? 'Campaign updated successfully!' : 'Campaign created successfully!',
                    'campaignId' => $campaign->getId(),
                    'redirect' => $this->router->generate('warmup_campaign_index'),
                ]);
            } else {
                $errors = [];
                foreach ($form->getErrors(true) as $error) {
                    $errors[] = $error->getMessage();
                }
                throw new \Exception('Form validation failed: ' . implode(', ', $errors));
            }

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => 'Error saving campaign: ' . $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Démarrer une campagne (AJAX)
     */
    public function startAction(Request $request, int $id): JsonResponse
    {
        try {
            $campaign = $this->campaignModel->getEntity($id);
            if (!$campaign) {
                throw new \Exception('Campaign not found');
            }

            $campaign->setStatus('active');
            $campaign->setStartDate(new \DateTime()); // Commencer immédiatement
            $this->campaignModel->saveEntity($campaign);

            // Planifier l'envoi automatique
            $this->scheduleNextSend($campaign);

            return new JsonResponse([
                'success' => true,
                'message' => 'Campaign started successfully!',
                'status' => 'active',
            ]);

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => 'Error starting campaign: ' . $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Mettre en pause une campagne (AJAX)
     */
    public function pauseAction(Request $request, int $id): JsonResponse
    {
        try {
            $campaign = $this->campaignModel->getEntity($id);
            if (!$campaign) {
                throw new \Exception('Campaign not found');
            }

            $campaign->setStatus('paused');
            $this->campaignModel->saveEntity($campaign);

            return new JsonResponse([
                'success' => true,
                'message' => 'Campaign paused',
                'status' => 'paused',
            ]);

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => 'Error pausing campaign: ' . $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Reprendre une campagne (AJAX)
     */
    public function resumeAction(Request $request, int $id): JsonResponse
    {
        try {
            $campaign = $this->campaignModel->getEntity($id);
            if (!$campaign) {
                throw new \Exception('Campaign not found');
            }

            $campaign->setStatus('active');
            $this->campaignModel->saveEntity($campaign);

            return new JsonResponse([
                'success' => true,
                'message' => 'Campaign resumed',
                'status' => 'active',
            ]);

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => 'Error resuming campaign: ' . $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Récupérer le progrès d'une campagne (AJAX)
     */
    public function progressAction(Request $request, int $id): JsonResponse
    {
        try {
            $campaign = $this->campaignModel->getEntity($id);
            if (!$campaign) {
                throw new \Exception('Campaign not found');
            }

            return new JsonResponse([
                'success' => true,
                'progress' => $campaign->getProgress(),
                'statistics' => $campaign->getStatistics(),
            ]);

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => 'Error getting progress: ' . $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Récupérer les contacts d'une campagne (AJAX)
     */
    public function contactsAction(Request $request, int $id): JsonResponse
    {
        try {
            $campaign = $this->campaignModel->getEntity($id);
            if (!$campaign) {
                throw new \Exception('Campaign not found');
            }

            $contacts = $this->em->getRepository(WarmupContact::class)
                ->findBy(['campaign' => $campaign]);

            $data = [];
            foreach ($contacts as $contact) {
                $data[] = [
                    'id' => $contact->getId(),
                    'email' => $contact->getEmailAddress(),
                    'firstName' => $contact->getFirstName(),
                    'lastName' => $contact->getLastName(),
                    'sentCount' => $contact->getSentCount(),
                    'lastSent' => $contact->getLastSent() ? $contact->getLastSent()->format('Y-m-d H:i') : null,
                    'nextSendDate' => $contact->getNextSendDate() ? $contact->getNextSendDate()->format('Y-m-d H:i') : null,
                ];
            }

            return new JsonResponse([
                'success' => true,
                'contacts' => $data,
                'count' => count($data),
            ]);

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => 'Error getting contacts: ' . $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Calculer le plan de warmup (AJAX)
     */
    public function calculateWarmupAction(Request $request): JsonResponse
    {
        try {
            $data = json_decode($request->getContent(), true);

            if (!isset($data['totalContacts'], $data['durationDays'], $data['warmupType'], $data['startVolume'])) {
                throw new \Exception('Missing required parameters');
            }

            $plan = $this->warmupCalculator->calculate(
                (int) $data['totalContacts'],
                (int) $data['durationDays'],
                $data['warmupType'],
                isset($data['ratio']) ? (float) $data['ratio'] : null,
                (int) $data['startVolume'],
                isset($data['increasePerDay']) ? (int) $data['increasePerDay'] : null
            );

            // Calculer les statistiques
            $stats = $this->calculateWarmupStats($plan);

            return new JsonResponse([
                'success' => true,
                'plan' => $plan,
                'stats' => $stats,
            ]);

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Envoyer un email test (AJAX)
     */
    public function sendTestEmailAction(Request $request): JsonResponse
    {
        try {
            $data = json_decode($request->getContent(), true);

            if (!isset($data['testEmail'], $data['domainId'], $data['subject'], $data['message'])) {
                throw new \Exception('Missing required parameters');
            }

            $domain = $this->em->getRepository(Domain::class)->find($data['domainId']);
            if (!$domain) {
                throw new \Exception('Domain not found');
            }

            // Envoyer l'email test via le service
            $result = $this->emailSender->sendTestEmail(
                $domain,
                $data['testEmail'],
                $data['subject'],
                $data['message']
            );

            return new JsonResponse([
                'success' => true,
                'message' => 'Test email sent successfully!',
                'details' => $result,
            ]);

        } catch (\Exception $e) {
            return new JsonResponse([
                'success' => false,
                'message' => 'Error sending test email: ' . $e->getMessage(),
            ], 400);
        }
    }

    /**
     * Traiter les contacts depuis différentes sources
     */
    private function processContacts(Campaign $campaign, Request $request): array
    {
        $contactSource = $request->request->get('contact_source', 'manual');
        $contacts = [];

        switch ($contactSource) {
            case 'manual':
                $manualText = $request->request->get('manual_contacts', '');
                $lines = array_filter(array_map('trim', explode("\n", $manualText)));
                foreach ($lines as $line) {
                    $email = trim($line);
                    if (filter_var($email, FILTER_VALIDATE_EMAIL)) {
                        $contacts[] = [
                            'email' => $email,
                            'first_name' => '',
                            'last_name' => '',
                        ];
                    }
                }
                break;

            case 'mautic':
                $segmentId = $request->request->get('segment_id');
                if ($segmentId) {
                    $segment = $this->segmentModel->getEntity($segmentId);
                    if ($segment) {
                        $mauticContacts = $this->segmentModel->getLeadsByList($segment, true);
                        foreach ($mauticContacts as $contact) {
                            $contacts[] = [
                                'email' => $contact['email'] ?? '',
                                'first_name' => $contact['firstname'] ?? '',
                                'last_name' => $contact['lastname'] ?? '',
                            ];
                        }
                    }
                }
                break;
        }

        return $contacts;
    }

    /**
     * Sauvegarder les contacts dans la base de données
     */
    private function saveContacts(Campaign $campaign, array $contacts): void
    {
        foreach ($contacts as $contactData) {
            $contact = new WarmupContact();
            $contact->setCampaign($campaign);
            $contact->setEmailAddress($contactData['email']);
            $contact->setFirstName($contactData['first_name']);
            $contact->setLastName($contactData['last_name']);
            $contact->setSequenceDay(1);
            $contact->setDaysBetweenEmails(2);
            $contact->setSentCount(0);
            $contact->setIsActive(true);
            $contact->setCreatedAt(new \DateTime());
            $contact->setUnsubscribeToken(bin2hex(random_bytes(32)));

            $this->em->persist($contact);
        }

        $this->em->flush();
    }

    /**
     * Calculer le plan de warmup pour une campagne
     */
    private function calculateWarmupPlan(Campaign $campaign): array
    {
        $warmupType = $campaign->getWarmupType();
        $typeName = $warmupType ? $warmupType->getTypeName() : 'arithmetic';

        $mapping = [
            'Arithmetic' => 'arithmetic',
            'Geometric' => 'geometric',
            'Flat' => 'flat',
            'Progressive' => 'progressive',
            'Randomize' => 'randomize',
        ];

        $progressionType = $mapping[$typeName] ?? 'arithmetic';

        return $this->warmupCalculator->calculate(
            $campaign->getTotalContacts(),
            $campaign->getDurationDays(),
            $progressionType,
            null,
            $campaign->getStartVolume(),
            null
        );
    }

    /**
     * Planifier l'envoi suivant pour une campagne
     */
    private function scheduleNextSend(Campaign $campaign): void
    {
        // Cette méthode sera appelée par un cron job ou une commande
        // Pour l'instant, on met juste à jour les dates de prochain envoi
        $contacts = $this->em->getRepository(WarmupContact::class)
            ->findBy(['campaign' => $campaign, 'isActive' => true]);

        $sendTime = $campaign->getSendTime();
        $now = new \DateTime();

        foreach ($contacts as $contact) {
            if (!$contact->getNextSendDate() || $contact->getNextSendDate() < $now) {
                $nextDate = clone $now;
                $nextDate->setTime($sendTime->format('H'), $sendTime->format('i'));
                $contact->setNextSendDate($nextDate);
                $this->em->persist($contact);
            }
        }

        $this->em->flush();
    }

    /**
     * Calculer les statistiques du plan de warmup
     */
    private function calculateWarmupStats(array $plan): array
    {
        $emails = array_column($plan, 'emails');

        if (empty($emails)) {
            return [
                'total' => 0,
                'average' => 0,
                'min' => 0,
                'max' => 0,
            ];
        }

        return [
            'total' => array_sum($emails),
            'average' => round(array_sum($emails) / count($emails), 1),
            'min' => min($emails),
            'max' => max($emails),
        ];
    }

    /**
     * Helper: Get status label
     */
    private function getStatusLabel(string $status): string
    {
        $labels = [
            'draft' => 'Draft',
            'active' => 'Active',
            'paused' => 'Paused',
            'completed' => 'Completed',
        ];
        return $labels[$status] ?? $status;
    }

    /**
     * Helper: Get status color
     */
    private function getStatusColor(string $status): string
    {
        $colors = [
            'draft' => 'default',
            'active' => 'success',
            'paused' => 'warning',
            'completed' => 'info',
        ];
        return $colors[$status] ?? 'default';
    }

    /**
     * Helper: Get action buttons HTML
     */
    private function getActionButtons(Campaign $campaign): string
    {
        $buttons = [];
        $id = $campaign->getId();

        // View button
        $buttons[] = '<a href="' . $this->router->generate('warmup_campaign_edit', ['id' => $id]) .
            '" class="btn btn-xs btn-default" title="Edit"><i class="fa fa-edit"></i></a>';

        // Start/Resume button
        if ($campaign->getStatus() === 'draft' || $campaign->getStatus() === 'paused') {
            $buttons[] = '<button class="btn btn-xs btn-success start-campaign" data-id="' . $id .
                '" title="Start Campaign"><i class="fa fa-play"></i></button>';
        }

        // Pause button
        if ($campaign->getStatus() === 'active') {
            $buttons[] = '<button class="btn btn-xs btn-warning pause-campaign" data-id="' . $id .
                '" title="Pause Campaign"><i class="fa fa-pause"></i></button>';
        }

        return implode(' ', $buttons);
    }
}